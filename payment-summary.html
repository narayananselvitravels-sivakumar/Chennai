<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payment Summary - NST Travels</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f4f7fc;
      font-family: 'Segoe UI', sans-serif;
    }
    .container {
      max-width: 1000px;
      margin: 30px auto;
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    h2 {
      margin-bottom: 20px;
      font-weight: 600;
    }
    table {
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ðŸ’° Payment Summary</h2>

    <div class="row mb-3 g-2">
      <div class="col-md-3">
        <input type="date" id="startDate" class="form-control" />
      </div>
      <div class="col-md-3">
        <input type="date" id="endDate" class="form-control" />
      </div>
      <div class="col-md-3">
        <select id="driverFilter" class="form-select">
          <option value="">All Drivers</option>
        </select>
      </div>
      <div class="col-md-3">
        <select id="vehicleFilter" class="form-select">
          <option value="">All Vehicles</option>
        </select>
      </div>
    </div>

    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>Trip ID</th>
          <th>Date</th>
          <th>Driver</th>
          <th>Vehicle</th>
          <th>Total Amount (â‚¹)</th>
          <th>Payment Status</th>
          <th>Change Status</th>
        </tr>
      </thead>
      <tbody id="paymentTableBody">
        <tr><td colspan="7" class="text-center">Loading...</td></tr>
      </tbody>
    </table>

    <div class="d-flex gap-2">
      <button class="btn btn-outline-primary" onclick="exportToExcel()">Export to Excel</button>
      <button class="btn btn-outline-danger" onclick="exportToPDF()">Export to PDF</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCz2rGDr0iREns6Rg6r1z5EHE3qhLDnEzs",
      authDomain: "narayananselvitravels-26dcb.firebaseapp.com",
      databaseURL: "https://narayananselvitravels-26dcb-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "narayananselvitravels-26dcb",
      storageBucket: "narayananselvitravels-26dcb.appspot.com",
      messagingSenderId: "395599682835",
      appId: "1:395599682835:web:9d46e03ca14aa0738dcee6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let allTrips = [];

    function populateFilters() {
      const drivers = new Set();
      const vehicles = new Set();
      allTrips.forEach(t => {
        if (t.driverName) drivers.add(t.driverName);
        if (t.vehicleModel) vehicles.add(t.vehicleModel);
      });

      const driverFilter = document.getElementById('driverFilter');
      driverFilter.innerHTML = '<option value="">All Drivers</option>';
      drivers.forEach(d => {
        driverFilter.innerHTML += `<option value="${d}">${d}</option>`;
      });

      const vehicleFilter = document.getElementById('vehicleFilter');
      vehicleFilter.innerHTML = '<option value="">All Vehicles</option>';
      vehicles.forEach(v => {
        vehicleFilter.innerHTML += `<option value="${v}">${v}</option>`;
      });
    }

    function renderTable() {
      const tbody = document.getElementById('paymentTableBody');
      tbody.innerHTML = '';

      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const driverFilter = document.getElementById('driverFilter').value;
      const vehicleFilter = document.getElementById('vehicleFilter').value;

      const filtered = allTrips.filter(t => {
        const inDateRange = (!startDate || t.date >= startDate) && (!endDate || t.date <= endDate);
        const matchesDriver = !driverFilter || t.driverName === driverFilter;
        const matchesVehicle = !vehicleFilter || t.vehicleModel === vehicleFilter;
        return inDateRange && matchesDriver && matchesVehicle;
      });

      if(filtered.length === 0){
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No data found</td></tr>';
        return;
      }

      filtered.forEach((trip, index) => {
        const row = document.createElement('tr');

        row.innerHTML = `
          <td>${trip.bookingId || ''}</td>
          <td>${trip.date || ''}</td>
          <td>${trip.driverName || ''}</td>
          <td>${trip.vehicleModel || ''}</td>
          <td>${trip.totalAmount || '0'}</td>
          <td>${trip.paymentStatus || 'Pending'}</td>
          <td>
            <select onchange="changePaymentStatus('${trip.bookingId}', this.value)">
              <option value="Paid" ${trip.paymentStatus === 'Paid' ? 'selected' : ''}>Paid</option>
              <option value="Pending" ${trip.paymentStatus === 'Pending' ? 'selected' : ''}>Pending</option>
              <option value="Not Paid" ${trip.paymentStatus === 'Not Paid' ? 'selected' : ''}>Not Paid</option>
            </select>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function changePaymentStatus(bookingId, newStatus) {
      // Find the trip key by bookingId
      db.ref('trips').orderByChild('bookingId').equalTo(bookingId).once('value', snapshot => {
        if(snapshot.exists()){
          snapshot.forEach(childSnap => {
            childSnap.ref.update({ paymentStatus: newStatus }).then(() => {
              alert(`Payment status updated to "${newStatus}" for ${bookingId}`);
              // Refresh data
              loadTrips();
            });
          });
        }
      });
    }

    function loadTrips() {
      db.ref('trips').once('value', snapshot => {
        allTrips = [];
        snapshot.forEach(child => {
          allTrips.push(child.val());
        });
        populateFilters();
        renderTable();
      });
    }

    function exportToExcel() {
      const XLSX = window.XLSX;
      const wb = XLSX.utils.book_new();
      const data = allTrips.map(t => ({
        'Trip ID': t.bookingId,
        'Date': t.date,
        'Driver': t.driverName,
        'Vehicle': t.vehicleModel,
        'Total Amount': t.totalAmount,
        'Payment Status': t.paymentStatus
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, 'Payments');
      XLSX.writeFile(wb, 'NST_Payments.xlsx');
    }

    async function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const rows = allTrips.map(t => [
        t.bookingId,
        t.date,
        t.driverName,
        t.vehicleModel,
        t.totalAmount,
        t.paymentStatus
      ]);
      doc.text('NST Payment Summary', 14, 15);
      doc.autoTable({
        head: [['Trip ID', 'Date', 'Driver', 'Vehicle', 'Total Amount', 'Payment Status']],
        body: rows,
        startY: 20,
        styles: { fontSize: 8 }
      });
      doc.save('NST_Payments.pdf');
    }

    // Add event listeners to filters
    ['startDate', 'endDate', 'driverFilter', 'vehicleFilter'].forEach(id => {
      document.getElementById(id).addEventListener('change', renderTable);
    });

    loadTrips();
  </script>
</body>
</html>
