<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Payment Summary - NST Travels</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f7f7f7; }
    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { padding: 12px; border: 1px solid #ccc; text-align: left; font-size: 14px; }
    th { background: #333; color: white; }
    .status-dropdown { width: 100%; padding: 6px; }
    .note { font-size: 0.75rem; color: green; margin-top: 4px; display: block; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .header a { padding: 8px 14px; background: #333; color: white; text-decoration: none; border-radius: 5px; }
  </style>
</head>
<body>

  <div class="header">
    <h2>Payment Summary</h2>
    <a href="admin-panel.html">Admin Panel</a>
  </div>

  <table id="paymentTable">
    <thead>
      <tr>
        <th>Trip ID</th>
        <th>Driver Name</th>
        <th>Vehicle</th>
        <th>Total Amount</th>
        <th>Paid Amount</th>
        <th>Balance</th>
        <th>Payment Status</th>
      </tr>
    </thead>
    <tbody id="paymentBody"></tbody>
  </table>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCz2rGDr0iREns6Rg6r1z5EHE3qhLDnEzs",
      authDomain: "narayananselvitravels-26dcb.firebaseapp.com",
      databaseURL: "https://narayananselvitravels-26dcb-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "narayananselvitravels-26dcb",
      storageBucket: "narayananselvitravels-26dcb.appspot.com",
      messagingSenderId: "395599682835",
      appId: "1:395599682835:web:9d46e03ca14aa0738dcee6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function loadTrips() {
      db.ref("trips").once("value", snapshot => {
        const body = document.getElementById("paymentBody");
        body.innerHTML = "";
        snapshot.forEach(child => {
          const trip = child.val();
          const total = parseFloat(trip.totalAmount || 0);
          const paid = parseFloat(trip.paidAmount || 0);
          const balance = (total - paid).toFixed(2);

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${trip.bookingId || ""}</td>
            <td>${trip.driverName || ""}</td>
            <td>${trip.vehicleModel || ""}</td>
            <td>₹${total}</td>
            <td>₹${paid}</td>
            <td>₹${balance}</td>
            <td>
              <select class="status-dropdown" onchange="changePaymentStatus('${trip.bookingId}', this.value, this)">
                <option value="">Select</option>
                <option value="Paid" ${trip.paymentStatus === "Paid" ? "selected" : ""}>Paid</option>
                <option value="Not Paid" ${trip.paymentStatus === "Not Paid" ? "selected" : ""}>Not Paid</option>
                <option value="Partial" ${trip.paymentStatus === "Partial" ? "selected" : ""}>Partially Paid</option>
              </select>
            </td>
          `;
          body.appendChild(row);
        });
      });
    }

    function changePaymentStatus(bookingId, newStatus, dropdownEl) {
      db.ref('trips').orderByChild('bookingId').equalTo(bookingId).once('value', snapshot => {
        if (!snapshot.exists()) return;
        snapshot.forEach(childSnap => {
          const trip = childSnap.val();
          const ref = childSnap.ref;

          const total = parseFloat(trip.totalAmount || 0);
          let updates = { paymentStatus: newStatus };

          if (newStatus === "Paid") {
            updates.paidAmount = total;
            showNote(dropdownEl, `Paid full amount ₹${total.toFixed(2)}. Balance cleared.`);
          } else if (newStatus === "Not Paid") {
            updates.paidAmount = 0;
            showNote(dropdownEl, `Marked as Not Paid. Full balance ₹${total.toFixed(2)}.`);
          } else {
            showNote(dropdownEl, `Marked as Partially Paid. No changes made.`);
          }

          ref.update(updates).then(() => {
            loadTrips();
          });
        });
      });
    }

    function showNote(dropdownEl, msg) {
      let cell = dropdownEl.closest('td');
      let note = document.createElement('span');
      note.className = "note";
      note.innerText = msg;
      cell.appendChild(note);
      setTimeout(() => note.remove(), 5000);
    }

    loadTrips();
  </script>
</body>
</html>
