<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Revenue Summary - NST Travels</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f4f7fc;
      padding: 15px;
    }
    .summary-box {
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      background-color: white;
      text-align: center;
    }
    h2, h4 {
      font-weight: bold;
    }
    @media (max-width: 767px) {
      .summary-box {
        font-size: 14px;
      }
      .btn {
        font-size: 12px;
        padding: 5px 8px;
      }
    }
  </style>
</head>
<body>
<div class="container py-5">
  <h2 class="text-center mb-4">💰 Revenue Summary</h2>

  <div class="row mb-4 g-2">
    <div class="col-md-2">
      <input type="date" id="startDate" class="form-control" aria-label="Start Date" />
    </div>
    <div class="col-md-2">
      <input type="date" id="endDate" class="form-control" aria-label="End Date" />
    </div>
    <div class="col-md-2">
      <select id="driverFilter" class="form-select" aria-label="Filter by Driver">
        <option value="">All Drivers</option>
      </select>
    </div>
    <div class="col-md-2">
      <select id="vehicleFilter" class="form-select" aria-label="Filter by Vehicle">
        <option value="">All Vehicles</option>
      </select>
    </div>
    <div class="col-md-2">
      <select id="customerFilter" class="form-select" aria-label="Filter by Customer">
        <option value="">All Customers</option>
      </select>
    </div>
    <div class="col-md-2">
      <select id="dutyFilter" class="form-select" aria-label="Filter by Duty">
        <option value="">All Duties</option>
      </select>
    </div>
    <div class="col-md-2">
      <select id="paymentStatusFilter" class="form-select" aria-label="Filter by Payment Status">
        <option value="">All Payment Statuses</option>
        <option value="Paid">Paid</option>
        <option value="Not Paid">Not Paid</option>
        <option value="Partially Paid">Partially Paid</option>
      </select>
    </div>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <div class="summary-box border border-dark">
        <h4>Total Revenue</h4>
        <h3 class="text-primary" id="totalAmount">₹0</h3>
      </div>
    </div>
    <div class="col-md-4">
      <div class="summary-box border border-success">
        <h4>Paid Amount</h4>
        <h3 class="text-success" id="paidAmount">₹0</h3>
      </div>
    </div>
    <div class="col-md-4">
      <div class="summary-box border border-danger">
        <h4>Pending Amount</h4>
        <h3 class="text-danger" id="pendingAmount">₹0</h3>
      </div>
    </div>
  </div>

  <div class="text-center">
    <button class="btn btn-outline-primary me-2" onclick="exportToExcel()">Export to Excel</button>
    <button class="btn btn-outline-danger me-2" onclick="exportToPDF()">Export to PDF</button>
    <button class="btn btn-outline-success" onclick="shareViaWhatsApp()">
      <i class="fa fa-whatsapp"></i> Share via WhatsApp
    </button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCz2rGDr0iREns6Rg6r1z5EHE3qhLDnEzs",
    authDomain: "narayananselvitravels-26dcb.firebaseapp.com",
    databaseURL: "https://narayananselvitravels-26dcb-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "narayananselvitravels-26dcb",
    storageBucket: "narayananselvitravels-26dcb.appspot.com",
    messagingSenderId: "395599682835",
    appId: "1:395599682835:web:9d46e03ca14aa0738dcee6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  let allTrips = [];

  function formatTimeTo12Hour(time) {
    if (!time) return "";
    const [hour, minute] = time.split(":").map(Number);
    const ampm = hour >= 12 ? "PM" : "AM";
    const hr12 = hour % 12 || 12;
    return `${hr12}:${minute.toString().padStart(2, '0')} ${ampm}`;
  }

  function populateDropdowns() {
    const driverSet = new Set();
    const vehicleSet = new Set();
    const customerSet = new Set();
    const dutySet = new Set();
    allTrips.forEach(t => {
      if (t.driverName) driverSet.add(t.driverName);
      if (t.vehicleModel) vehicleSet.add(t.vehicleModel);
      if (t.customerName) customerSet.add(t.customerName);
      if (t.duty) dutySet.add(t.duty);
    });

    const driverFilter = document.getElementById("driverFilter");
    driverFilter.innerHTML = '<option value="">All Drivers</option>';
    driverSet.forEach(d => {
      driverFilter.innerHTML += `<option value="${d}">${d}</option>`;
    });

    const vehicleFilter = document.getElementById("vehicleFilter");
    vehicleFilter.innerHTML = '<option value="">All Vehicles</option>';
    vehicleSet.forEach(v => {
      vehicleFilter.innerHTML += `<option value="${v}">${v}</option>`;
    });

    const customerFilter = document.getElementById("customerFilter");
    customerFilter.innerHTML = '<option value="">All Customers</option>';
    customerSet.forEach(c => {
      customerFilter.innerHTML += `<option value="${c}">${c}</option>`;
    });

    const dutyFilter = document.getElementById("dutyFilter");
    dutyFilter.innerHTML = '<option value="">All Duties</option>';
    dutySet.forEach(d => {
      dutyFilter.innerHTML += `<option value="${d}">${d}</option>`;
    });
  }

  function updateRevenue() {
    let total = 0, paid = 0, pending = 0;
    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;
    const driver = document.getElementById("driverFilter").value;
    const vehicle = document.getElementById("vehicleFilter").value;
    const customer = document.getElementById("customerFilter").value;
    const duty = document.getElementById("dutyFilter").value;
    const paymentStatus = document.getElementById("paymentStatusFilter").value;

    const filtered = allTrips.filter(t => {
      const inDateRange = (!start || t.date >= start) && (!end || t.date <= end);
      const matchDriver = !driver || t.driverName === driver;
      const matchVehicle = !vehicle || t.vehicleModel === vehicle;
      const matchCustomer = !customer || t.customerName === customer;
      const matchDuty = !duty || t.duty === duty;
      const matchPaymentStatus = !paymentStatus || t.paymentStatus === paymentStatus;
      return inDateRange && matchDriver && matchVehicle && matchCustomer && matchDuty && matchPaymentStatus;
    });

    filtered.forEach(t => {
      const totalAmt = parseFloat(t.totalAmount || 0);
      const paidAmt = parseFloat(t.paidAmount || 0);
      const balanceAmt = parseFloat(t.balanceAmount || 0);
      total += totalAmt;
      if (t.paymentStatus === "Paid" || t.paymentStatus === "Partially Paid") {
        paid += paidAmt;
      }
      if (t.paymentStatus === "Partially Paid") {
        pending += balanceAmt;
      } else if (t.paymentStatus === "Not Paid") {
        pending += totalAmt;
      }
    });

    document.getElementById("totalAmount").textContent = `₹${total.toLocaleString('en-IN')}`;
    document.getElementById("paidAmount").textContent = `₹${paid.toLocaleString('en-IN')}`;
    document.getElementById("pendingAmount").textContent = `₹${pending.toLocaleString('en-IN')}`;
  }

  function exportToExcel() {
    if (!allTrips.length) {
      alert("No trips to export.");
      return;
    }
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(allTrips.map(t => ({
      "Trip ID": t.bookingId,
      "Date": t.date,
      "Duty": t.duty,
      "Customer": t.customerName,
      "Driver": t.driverName,
      "Vehicle": t.vehicleModel,
      "Total Amount": `₹${t.totalAmount}`,
      "Payment Status": t.paymentStatus,
      "Paid Amount": t.paymentStatus === "Paid" || t.paymentStatus === "Partially Paid" ? `₹${t.paidAmount || "0"}` : "",
      "Balance Amount": t.paymentStatus === "Partially Paid" ? `₹${t.balanceAmount || "0"}` : "",
      "Start Time": formatTimeTo12Hour(t.startTime),
      "End Time": formatTimeTo12Hour(t.endTime)
    })));
    ws['!cols'] = [
      { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 20 }, { wch: 20 },
      { wch: 20 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 },
      { wch: 15 }, { wch: 15 }
    ];
    XLSX.utils.book_append_sheet(wb, ws, "Revenue");
    XLSX.writeFile(wb, "NST_Revenue.xlsx");
  }

  function exportToPDF() {
    if (!allTrips.length) {
      alert("No trips to export.");
      return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const rows = allTrips.map(t => [
      t.bookingId,
      t.date,
      t.duty,
      t.customerName,
      t.driverName,
      t.vehicleModel,
      `₹${t.totalAmount}`,
      t.paymentStatus,
      t.paymentStatus === "Paid" || t.paymentStatus === "Partially Paid" ? `₹${t.paidAmount || "0"}` : "",
      t.paymentStatus === "Partially Paid" ? `₹${t.balanceAmount || "0"}` : "",
      formatTimeTo12Hour(t.startTime),
      formatTimeTo12Hour(t.endTime)
    ]);
    doc.text("NST Revenue Summary", 14, 15);
    doc.autoTable({
      head: [["Trip ID", "Date", "Duty", "Customer", "Driver", "Vehicle", "Total Amount", "Payment Status", "Paid Amount", "Balance Amount", "Start Time", "End Time"]],
      body: rows,
      startY: 20,
      styles: { fontSize: 8 },
      columnStyles: {
        0: { cellWidth: 20 },
        1: { cellWidth: 25 },
        2: { cellWidth: 20 },
        3: { cellWidth: 25 },
        4: { cellWidth: 25 },
        5: { cellWidth: 25 },
        6: { cellWidth: 20 },
        7: { cellWidth: 20 },
        8: { cellWidth: 20 },
        9: { cellWidth: 20 },
        10: { cellWidth: 20 },
        11: { cellWidth: 20 }
      }
    });
    doc.save("NST_Revenue.pdf");
  }

  function shareViaWhatsApp() {
    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;
    const driver = document.getElementById("driverFilter").value;
    const vehicle = document.getElementById("vehicleFilter").value;
    const customer = document.getElementById("customerFilter").value;
    const duty = document.getElementById("dutyFilter").value;
    const paymentStatus = document.getElementById("paymentStatusFilter").value;
    const total = document.getElementById("totalAmount").textContent;
    const paid = document.getElementById("paidAmount").textContent;
    const pending = document.getElementById("pendingAmount").textContent;

    const message = `
📊 *NST Revenue Summary*

📅 *Date Range*: ${start || "All"} to ${end || "All"}
👨‍✈ *Driver*: ${driver || "All"}
🚘 *Vehicle*: ${vehicle || "All"}
👤 *Customer*: ${customer || "All"}
📋 *Duty*: ${duty || "All"}
💳 *Payment Status*: ${paymentStatus || "All"}

💰 *Financial Summary*
• Total Revenue: ${total}
• Paid Amount: ${paid}
• Pending Amount: ${pending}
    `.trim();

    const url = "https://wa.me/?text=" + encodeURIComponent(message);
    window.open(url, "_blank");
  }

  onValue(ref(db, "trips"), (snapshot) => {
    allTrips = [];
    snapshot.forEach(child => {
      allTrips.push(child.val());
    });
    populateDropdowns();
    updateRevenue();
  });

  ["startDate", "endDate", "driverFilter", "vehicleFilter", "customerFilter", "dutyFilter", "paymentStatusFilter"].forEach(id => {
    document.getElementById(id).addEventListener("change", updateRevenue);
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
</body>
</html>
