<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Revenue Summary - NST Travels</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      background-color: #f4f7fc;
    }
    .summary-box {
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      background-color: white;
      text-align: center;
    }
    h2, h4 {
      font-weight: bold;
    }
  </style>
</head>
<body>
<div class="container py-5">
  <h2 class="text-center mb-4">ðŸ’° Revenue Summary</h2>

  <div class="row mb-4">
    <div class="col-md-3">
      <input type="date" id="startDate" class="form-control" />
    </div>
    <div class="col-md-3">
      <input type="date" id="endDate" class="form-control" />
    </div>
    <div class="col-md-3">
      <select id="driverFilter" class="form-select">
        <option value="">All Drivers</option>
      </select>
    </div>
    <div class="col-md-3">
      <select id="vehicleFilter" class="form-select">
        <option value="">All Vehicles</option>
      </select>
    </div>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <div class="summary-box border border-dark">
        <h4>Total Revenue</h4>
        <h3 class="text-primary" id="totalAmount">â‚¹0</h3>
      </div>
    </div>
    <div class="col-md-4">
      <div class="summary-box border border-success">
        <h4>Paid Amount</h4>
        <h3 class="text-success" id="paidAmount">â‚¹0</h3>
      </div>
    </div>
    <div class="col-md-4">
      <div class="summary-box border border-danger">
        <h4>Pending Amount</h4>
        <h3 class="text-danger" id="pendingAmount">â‚¹0</h3>
      </div>
    </div>
  </div>

  <div class="text-center">
    <button class="btn btn-outline-primary me-2" onclick="exportToExcel()">Export to Excel</button>
    <button class="btn btn-outline-danger" onclick="exportToPDF()">Export to PDF</button>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCz2rGDr0iREns6Rg6r1z5EHE3qhLDnEzs",
    authDomain: "narayananselvitravels-26dcb.firebaseapp.com",
    databaseURL: "https://narayananselvitravels-26dcb-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "narayananselvitravels-26dcb",
    storageBucket: "narayananselvitravels-26dcb.appspot.com",
    messagingSenderId: "395599682835",
    appId: "1:395599682835:web:9d46e03ca14aa0738dcee6"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  let allTrips = [];

  function formatTimeTo12Hour(time) {
    if (!time) return "";
    const [hour, minute] = time.split(":").map(Number);
    const ampm = hour >= 12 ? "PM" : "AM";
    const hr12 = hour % 12 || 12;
    return `${hr12}:${minute.toString().padStart(2, '0')} ${ampm}`;
  }

  function populateDropdowns() {
    const driverSet = new Set();
    const vehicleSet = new Set();
    allTrips.forEach(t => {
      if (t.driverName) driverSet.add(t.driverName);
      if (t.vehicleModel) vehicleSet.add(t.vehicleModel);
    });

    const driverFilter = document.getElementById("driverFilter");
    driverFilter.innerHTML = '<option value="">All Drivers</option>';
    driverSet.forEach(d => {
      driverFilter.innerHTML += `<option value="${d}">${d}</option>`;
    });

    const vehicleFilter = document.getElementById("vehicleFilter");
    vehicleFilter.innerHTML = '<option value="">All Vehicles</option>';
    vehicleSet.forEach(v => {
      vehicleFilter.innerHTML += `<option value="${v}">${v}</option>`;
    });
  }

  function updateRevenue() {
    let total = 0, paid = 0, pending = 0;
    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;
    const driver = document.getElementById("driverFilter").value;
    const vehicle = document.getElementById("vehicleFilter").value;

    const filtered = allTrips.filter(t => {
      const inDateRange = (!start || t.date >= start) && (!end || t.date <= end);
      const matchDriver = !driver || t.driverName === driver;
      const matchVehicle = !vehicle || t.vehicleModel === vehicle;
      return inDateRange && matchDriver && matchVehicle;
    });

    filtered.forEach(t => {
      const amt = parseFloat(t.totalAmount || 0);
      total += amt;
      if (t.paymentStatus === "Paid") paid += amt;
      else pending += amt;
    });

    document.getElementById("totalAmount").textContent = `â‚¹${total.toLocaleString()}`;
    document.getElementById("paidAmount").textContent = `â‚¹${paid.toLocaleString()}`;
    document.getElementById("pendingAmount").textContent = `â‚¹${pending.toLocaleString()}`;
  }

  function exportToExcel() {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(allTrips.map(t => ({
      ...t,
      startTime: formatTimeTo12Hour(t.startTime),
      endTime: formatTimeTo12Hour(t.endTime)
    })));
    XLSX.utils.book_append_sheet(wb, ws, "Trips");
    XLSX.writeFile(wb, "NST_Revenue.xlsx");
  }

  async function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const rows = allTrips.map(t => [
      t.bookingId,
      t.date,
      t.driverName,
      t.vehicleModel,
      `â‚¹${t.totalAmount}`,
      t.paymentStatus,
      formatTimeTo12Hour(t.startTime),
      formatTimeTo12Hour(t.endTime)
    ]);
    doc.text("NST Revenue Summary", 14, 15);
    doc.autoTable({
      head: [["Trip ID", "Date", "Driver", "Vehicle", "Amount", "Status", "Start Time", "End Time"]],
      body: rows,
      startY: 20,
      styles: { fontSize: 8 }
    });
    doc.save("NST_Revenue.pdf");
  }

  db.ref("trips").once("value", (snapshot) => {
    allTrips = [];
    snapshot.forEach(child => {
      allTrips.push(child.val());
    });
    populateDropdowns();
    updateRevenue();
  });

  ["startDate", "endDate", "driverFilter", "vehicleFilter"].forEach(id => {
    document.getElementById(id).addEventListener("change", updateRevenue);
  });
</script>
</body>
</html>
