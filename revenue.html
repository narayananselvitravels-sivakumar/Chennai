<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Revenue Summary - NST Travels</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: #f3f4f6;
      font-weight: 600;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      padding: 2.5rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    .input-field, .select-field {
      width: 100%;
      padding: 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
      font-size: 1.1rem;
      font-weight: 600;
      transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .input-field:focus, .select-field:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
    }
    .btn {
      font-size: 1.1rem;
      font-weight: 700;
      transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
    }
    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
    }
    .btn:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    .summary-box {
      padding: 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      background-color: white;
      text-align: center;
      border: 2px solid;
    }
    .section-heading {
      font-size: 1.5rem;
      font-weight: 800;
      color: #1f2937;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
    }
    .form-label {
      font-size: 1.1rem;
      font-weight: 700;
      color: #1f2937;
    }
    .nav-link {
      font-size: 1.1rem;
      font-weight: 600;
    }
    .summary-value {
      font-size: 1.75rem;
      font-weight: 800;
    }
    .pending-item {
      font-size: 1.1rem;
      font-weight: 600;
    }
    .footer-text {
      font-size: 1rem;
      font-weight: 600;
    }
    @media (max-width: 640px) {
      .container {
        padding: 1.5rem;
      }
      .input-field, .select-field {
        font-size: 0.9rem;
      }
      .btn {
        font-size: 0.9rem;
        padding: 0.75rem 1rem;
      }
      .section-heading {
        font-size: 1.25rem;
      }
      .form-label {
        font-size: 0.95rem;
      }
      .nav-link {
        font-size: 0.9rem;
      }
      .summary-box {
        padding: 1rem;
      }
      .summary-value {
        font-size: 1.25rem;
      }
      .pending-item {
        font-size: 0.9rem;
      }
      .footer-text {
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center">
          <a href="#" class="text-3xl font-bold text-indigo-600">NST Travels</a>
        </div>
        <div class="hidden sm:flex items-center space-x-4">
          <a href="admin-dashboard.html" class="nav-link text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md">Dashboard</a>
          <a href="attendance.html" class="nav-link text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md">Attendance</a>
          <a href="driver-dashboard.html" class="nav-link text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md">Driver Dashboard</a>
          <a href="drivers-vehicles.html" class="nav-link text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md">Drivers & Vehicles</a>
          <a href="payment-summary.html" class="nav-link text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md">Payment Summary</a>
          <a href="revenue.html" class="nav-link text-indigo-600 font-bold px-3 py-2 rounded-md">Revenue</a>
          <a href="trip-summary.html" class="nav-link text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md">Trip Summary</a>
          <a href="trip.html" class="nav-link text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md">Trip Entry</a>
        </div>
      </div>
    </div>
  </nav>

  <div class="container max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h2 class="text-3xl font-bold text-gray-900 mb-8"><i class="fas fa-money-bill-wave mr-2"></i> Revenue Summary</h2>

    <!-- Filters -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
      <div>
        <label for="startDate" class="form-label block mb-1">Start Date</label>
        <input type="date" id="startDate" class="input-field w-full" aria-label="Start Date" />
      </div>
      <div>
        <label for="endDate" class="form-label block mb-1">End Date</label>
        <input type="date" id="endDate" class="input-field w-full" aria-label="End Date" />
      </div>
      <div>
        <label for="driverFilter" class="form-label block mb-1">Driver</label>
        <select id="driverFilter" class="select-field w-full" aria-label="Filter by Driver">
          <option value="">All Drivers</option>
        </select>
      </div>
      <div>
        <label for="vehicleFilter" class="form-label block mb-1">Vehicle</label>
        <select id="vehicleFilter" class="select-field w-full" aria-label="Filter by Vehicle">
          <option value="">All Vehicles</option>
        </select>
      </div>
      <div>
        <label for="customerFilter" class="form-label block mb-1">Customer</label>
        <select id="customerFilter" class="select-field w-full" aria-label="Filter by Customer">
          <option value="">All Customers</option>
        </select>
      </div>
      <div>
        <label for="dutyFilter" class="form-label block mb-1">Duty</label>
        <select id="dutyFilter" class="select-field w-full" aria-label="Filter by Duty">
          <option value="">All Duties</option>
        </select>
      </div>
      <div>
        <label for="paymentStatusFilter" class="form-label block mb-1">Payment Status</label>
        <select id="paymentStatusFilter" class="select-field w-full" aria-label="Filter by Payment Status">
          <option value="">All Payment Statuses</option>
          <option value="Paid">Paid</option>
          <option value="Not Paid">Not Paid</option>
          <option value="Partially Paid">Partially Paid</option>
        </select>
      </div>
    </div>

    <!-- Summary Boxes -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6">
      <div class="summary-box border-indigo-600">
        <h4 class="text-lg font-bold text-gray-900 mb-2">Total Revenue</h4>
        <h3 class="summary-value text-indigo-600" id="totalAmount">₹0</h3>
      </div>
      <div class="summary-box border-green-600">
        <h4 class="text-lg font-bold text-gray-900 mb-2">Paid Amount</h4>
        <h3 class="summary-value text-green-600" id="paidAmount">₹0</h3>
      </div>
      <div class="summary-box border-red-600">
        <h4 class="text-lg font-bold text-gray-900 mb-2">Pending Amount</h4>
        <h3 class="summary-value text-red-600" id="pendingAmount">₹0</h3>
      </div>
    </div>

    <!-- Pending Payments by Customer/Duty -->
    <div class="mb-6">
      <h5 class="section-heading"><i class="fas fa-exclamation-circle mr-2"></i> Pending Payments</h5>
      <div class="mb-4">
        <label for="pendingFilter" class="form-label block mb-1">View By</label>
        <select id="pendingFilter" class="select-field w-full max-w-xs" aria-label="Filter Pending Payments">
          <option value="customer">Customer</option>
          <option value="duty">Duty</option>
        </select>
      </div>
      <div id="pendingList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-wrap justify-center gap-4">
      <button class="btn bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700" onclick="exportToExcel()">
        <i class="fas fa-file-excel mr-2"></i> Export to Excel
      </button>
      <button class="btn bg-red-600 text-white px-6 py-3 rounded-md hover:bg-red-700" onclick="exportToPDF()">
        <i class="fas fa-file-pdf mr-2"></i> Export to PDF
      </button>
      <button class="btn bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700" onclick="shareViaWhatsApp()">
        <i class="fas fa-whatsapp mr-2"></i> Share via WhatsApp
      </button>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white py-6 mt-auto">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <p class="footer-text">© 2025 NST Travels. All rights reserved.</p>
    </div>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCz2rGDr0iREns6Rg6r1z5EHE3qhLDnEzs",
      authDomain: "narayananselvitravels-26dcb.firebaseapp.com",
      databaseURL: "https://narayananselvitravels-26dcb-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "narayananselvitravels-26dcb",
      storageBucket: "narayananselvitravels-26dcb.appspot.com",
      messagingSenderId: "395599682835",
      appId: "1:395599682835:web:9d46e03ca14aa0738dcee6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let allTrips = [];

    function formatTimeTo12Hour(time) {
      if (!time) return "";
      const [hour, minute] = time.split(":").map(Number);
      const ampm = hour >= 12 ? "PM" : "AM";
      const hr12 = hour % 12 || 12;
      return `${hr12}:${minute.toString().padStart(2, '0')} ${ampm}`;
    }

    function populateDropdowns() {
      const driverSet = new Set();
      const vehicleSet = new Set();
      const customerSet = new Set();
      const dutySet = new Set();
      allTrips.forEach(t => {
        if (t.driverName) driverSet.add(t.driverName);
        if (t.vehicleModel) vehicleSet.add(t.vehicleModel);
        if (t.customerName) customerSet.add(t.customerName);
        if (t.duty) dutySet.add(t.duty);
      });

      const driverFilter = document.getElementById("driverFilter");
      driverFilter.innerHTML = '<option value="">All Drivers</option>';
      driverSet.forEach(d => {
        driverFilter.innerHTML += `<option value="${d}">${d}</option>`;
      });

      const vehicleFilter = document.getElementById("vehicleFilter");
      vehicleFilter.innerHTML = '<option value="">All Vehicles</option>';
      vehicleSet.forEach(v => {
        vehicleFilter.innerHTML += `<option value="${v}">${v}</option>`;
      });

      const customerFilter = document.getElementById("customerFilter");
      customerFilter.innerHTML = '<option value="">All Customers</option>';
      customerSet.forEach(c => {
        customerFilter.innerHTML += `<option value="${c}">${c}</option>`;
      });

      const dutyFilter = document.getElementById("dutyFilter");
      dutyFilter.innerHTML = '<option value="">All Duties</option>';
      dutySet.forEach(d => {
        dutyFilter.innerHTML += `<option value="${d}">${d}</option>`;
      });
    }

    function updateRevenue() {
      let total = 0, paid = 0, pending = 0;
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      const driver = document.getElementById("driverFilter").value;
      const vehicle = document.getElementById("vehicleFilter").value;
      const customer = document.getElementById("customerFilter").value;
      const duty = document.getElementById("dutyFilter").value;
      const paymentStatus = document.getElementById("paymentStatusFilter").value;

      const filtered = allTrips.filter(t => {
        const inDateRange = (!start || t.date >= start) && (!end || t.date <= end);
        const matchDriver = !driver || t.driverName === driver;
        const matchVehicle = !vehicle || t.vehicleModel === vehicle;
        const matchCustomer = !customer || t.customerName === customer;
        const matchDuty = !duty || t.duty === duty;
        const matchPaymentStatus = !paymentStatus || t.paymentStatus === paymentStatus;
        return inDateRange && matchDriver && matchVehicle && matchCustomer && matchDuty && matchPaymentStatus;
      });

      filtered.forEach(t => {
        const totalAmt = parseFloat(t.totalAmount || 0);
        const paidAmt = parseFloat(t.paidAmount || 0);
        const balanceAmt = parseFloat(t.balanceAmount || 0);
        total += totalAmt;
        if (t.paymentStatus === "Paid" || t.paymentStatus === "Partially Paid") {
          paid += paidAmt;
        }
        if (t.paymentStatus === "Partially Paid") {
          pending += balanceAmt;
        } else if (t.paymentStatus === "Not Paid") {
          pending += totalAmt;
        }
      });

      document.getElementById("totalAmount").textContent = `₹${total.toLocaleString('en-IN')}`;
      document.getElementById("paidAmount").textContent = `₹${paid.toLocaleString('en-IN')}`;
      document.getElementById("pendingAmount").textContent = `₹${pending.toLocaleString('en-IN')}`;

      updatePendingList();
    }

    function updatePendingList() {
      const pendingFilter = document.getElementById("pendingFilter").value;
      const pendingList = document.getElementById("pendingList");
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      const driver = document.getElementById("driverFilter").value;
      const vehicle = document.getElementById("vehicleFilter").value;
      const customer = document.getElementById("customerFilter").value;
      const duty = document.getElementById("dutyFilter").value;

      const filtered = allTrips.filter(t => {
        const inDateRange = (!start || t.date >= start) && (!end || t.date <= end);
        const matchDriver = !driver || t.driverName === driver;
        const matchVehicle = !vehicle || t.vehicleModel === vehicle;
        const matchCustomer = !customer || t.customerName === customer;
        const matchDuty = !duty || t.duty === duty;
        const isPending = t.paymentStatus === "Not Paid" || t.paymentStatus === "Partially Paid";
        return inDateRange && matchDriver && matchVehicle && matchCustomer && matchDuty && isPending;
      });

      const pendingData = {};
      filtered.forEach(t => {
        const key = pendingFilter === "customer" ? t.customerName : t.duty;
        if (!key) return;
        const amount = t.paymentStatus === "Not Paid" ? parseFloat(t.totalAmount || 0) : parseFloat(t.balanceAmount || 0);
        pendingData[key] = (pendingData[key] || 0) + amount;
      });

      pendingList.innerHTML = "";
      if (Object.keys(pendingData).length === 0) {
        pendingList.innerHTML = '<p class="text-gray-600 text-lg font-semibold">No pending payments found.</p>';
        return;
      }

      Object.entries(pendingData).forEach(([key, amount]) => {
        const div = document.createElement("div");
        div.className = "pending-item bg-gray-100 p-4 rounded-md";
        div.innerHTML = `
          <p class="font-bold text-gray-900">${pendingFilter === "customer" ? "Customer" : "Duty"}: ${key}</p>
          <p class="text-red-600">Pending: ₹${amount.toLocaleString('en-IN')}</p>
        `;
        pendingList.appendChild(div);
      });
    }

    function exportToExcel() {
      if (!allTrips.length) {
        alert("No trips to export.");
        return;
      }
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(allTrips.map(t => ({
        "Trip ID": t.bookingId,
        "Date": t.date,
        "Duty": t.duty,
        "Customer": t.customerName,
        "Driver": t.driverName,
        "Vehicle": t.vehicleModel,
        "Total Amount": `₹${t.totalAmount}`,
        "Payment Status": t.paymentStatus,
        "Paid Amount": t.paymentStatus === "Paid" || t.paymentStatus === "Partially Paid" ? `₹${t.paidAmount || "0"}` : "",
        "Balance Amount": t.paymentStatus === "Partially Paid" ? `₹${t.balanceAmount || "0"}` : "",
        "Start Time": formatTimeTo12Hour(t.startTime),
        "End Time": formatTimeTo12Hour(t.endTime)
      })));
      ws['!cols'] = [
        { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 20 }, { wch: 20 },
        { wch: 20 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 },
        { wch: 15 }, { wch: 15 }
      ];
      XLSX.utils.book_append_sheet(wb, ws, "Revenue");
      XLSX.writeFile(wb, "NST_Revenue.xlsx");
    }

    function exportToPDF() {
      if (!allTrips.length) {
        alert("No trips to export.");
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const rows = allTrips.map(t => [
        t.bookingId,
        t.date,
        t.duty,
        t.customerName,
        t.driverName,
        t.vehicleModel,
        `₹${t.totalAmount}`,
        t.paymentStatus,
        t.paymentStatus === "Paid" || t.paymentStatus === "Partially Paid" ? `₹${t.paidAmount || "0"}` : "",
        t.paymentStatus === "Partially Paid" ? `₹${t.balanceAmount || "0"}` : "",
        formatTimeTo12Hour(t.startTime),
        formatTimeTo12Hour(t.endTime)
      ]);
      doc.text("NST Revenue Summary", 14, 15);
      doc.autoTable({
        head: [["Trip ID", "Date", "Duty", "Customer", "Driver", "Vehicle", "Total Amount", "Payment Status", "Paid Amount", "Balance Amount", "Start Time", "End Time"]],
        body: rows,
        startY: 20,
        styles: { fontSize: 8 },
        columnStyles: {
          0: { cellWidth: 20 },
          1: { cellWidth: 25 },
          2: { cellWidth: 20 },
          3: { cellWidth: 25 },
          4: { cellWidth: 25 },
          5: { cellWidth: 25 },
          6: { cellWidth: 20 },
          7: { cellWidth: 20 },
          8: { cellWidth: 20 },
          9: { cellWidth: 20 },
          10: { cellWidth: 20 },
          11: { cellWidth: 20 }
        }
      });
      doc.save("NST_Revenue.pdf");
    }

    function shareViaWhatsApp() {
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      const driver = document.getElementById("driverFilter").value;
      const vehicle = document.getElementById("vehicleFilter").value;
      const customer = document.getElementById("customerFilter").value;
      const duty = document.getElementById("dutyFilter").value;
      const paymentStatus = document.getElementById("paymentStatusFilter").value;
      const total = document.getElementById("totalAmount").textContent;
      const paid = document.getElementById("paidAmount").textContent;
      const pending = document.getElementById("pendingAmount").textContent;

      const pendingFilter = document.getElementById("pendingFilter").value;
      const filtered = allTrips.filter(t => {
        const inDateRange = (!start || t.date >= start) && (!end || t.date <= end);
        const matchDriver = !driver || t.driverName === driver;
        const matchVehicle = !vehicle || t.vehicleModel === vehicle;
        const matchCustomer = !customer || t.customerName === customer;
        const matchDuty = !duty || t.duty === duty;
        const isPending = t.paymentStatus === "Not Paid" || t.paymentStatus === "Partially Paid";
        return inDateRange && matchDriver && matchVehicle && matchCustomer && matchDuty && isPending;
      });

      const pendingData = {};
      filtered.forEach(t => {
        const key = pendingFilter === "customer" ? t.customerName : t.duty;
        if (!key) return;
        const amount = t.paymentStatus === "Not Paid" ? parseFloat(t.totalAmount || 0) : parseFloat(t.balanceAmount || 0);
        pendingData[key] = (pendingData[key] || 0) + amount;
      });

      let pendingMessage = `\n\n📋 *Pending Payments by ${pendingFilter === "customer" ? "Customer" : "Duty"}*`;
      if (Object.keys(pendingData).length === 0) {
        pendingMessage += "\n• No pending payments found.";
      } else {
        Object.entries(pendingData).forEach(([key, amount]) => {
          pendingMessage += `\n• ${key}: ₹${amount.toLocaleString('en-IN')}`;
        });
      }

      const message = `
📊 *NST Revenue Summary*

📅 *Date Range*: ${start || "All"} to ${end || "All"}
👨‍✈ *Driver*: ${driver || "All"}
🚘 *Vehicle*: ${vehicle || "All"}
👤 *Customer*: ${customer || "All"}
📋 *Duty*: ${duty || "All"}
💳 *Payment Status*: ${paymentStatus || "All"}

💰 *Financial Summary*
• Total Revenue: ${total}
• Paid Amount: ${paid}
• Pending Amount: ${pending}${pendingMessage}
      `.trim();

      const url = "https://wa.me/?text=" + encodeURIComponent(message);
      window.open(url, "_blank");
    }

    onValue(ref(db, "trips"), (snapshot) => {
      allTrips = [];
      snapshot.forEach(child => {
        allTrips.push(child.val());
      });
      populateDropdowns();
      updateRevenue();
    });

    ["startDate", "endDate", "driverFilter", "vehicleFilter", "customerFilter", "dutyFilter", "paymentStatusFilter", "pendingFilter"].forEach(id => {
      document.getElementById(id).addEventListener("change", updateRevenue);
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
</body>
</html>
