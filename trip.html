<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NST Trip Entry</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body {
      background-color: #f4f7fc;
      font-family: 'Segoe UI', sans-serif;
    }
    .container {
      max-width: 900px;
      margin-top: 30px;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    h3, h5 {
      margin-top: 25px;
      font-weight: 600;
    }
    .form-label {
      font-weight: 500;
    }
    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <h3>📋 NST Trip Summary</h3>
  <form id="tripForm">

    <!-- 🗓 TRIP DETAILS -->
    <h5>🗓 Trip Details</h5>
    <div class="row mb-3">
      <div class="col-md-4">
        <label class="form-label">Trip ID</label>
        <input type="text" class="form-control" id="bookingId" readonly />
      </div>
      <div class="col-md-4">
        <label class="form-label">Date</label>
        <input type="date" class="form-control" id="date" required />
      </div>
      <div class="col-md-4">
        <label class="form-label">Duty</label>
        <input type="text" class="form-control" id="duty" required />
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-4">
        <label class="form-label">Reference</label>
        <input type="text" class="form-control" id="reference" />
      </div>
    </div>

    <!-- 📍 LOCATIONS -->
    <h5>📍 Locations</h5>
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">Pickup</label>
        <input type="text" class="form-control" id="pickupLocation" required />
      </div>
      <div class="col-md-6">
        <label class="form-label">Drop</label>
        <input type="text" class="form-control" id="dropLocation" required />
      </div>
    </div>

    <!-- 👤 CUSTOMER INFO -->
    <h5>👤 Customer Info</h5>
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">Name</label>
        <input type="text" class="form-control" id="customerName" required />
      </div>
      <div class="col-md-6">
        <label class="form-label">Number</label>
        <input type="tel" class="form-control" id="customerNumber" required />
      </div>
    </div>

    <!-- 👨‍✈ DRIVER INFO -->
    <h5>👨‍✈ Driver Info</h5>
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">Name</label>
        <select class="form-select" id="driverName" required>
          <option value="">Select Driver</option>
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Number</label>
        <input type="tel" class="form-control" id="driverNumber" readonly />
      </div>
    </div>

    <!-- 🚘 VEHICLE INFO -->
    <h5>🚘 Vehicle Info</h5>
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">Model</label>
        <select class="form-select" id="vehicleModel" required>
          <option value="">Select Vehicle Model</option>
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Number</label>
        <input type="text" class="form-control" id="vehicleNumber" readonly />
      </div>
    </div>

    <!-- 🕒 TIME DETAILS -->
    <h5>🕒 Time Details</h5>
    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label">Start Time</label>
        <input type="time" class="form-control" id="startTime" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">End Time</label>
        <input type="time" class="form-control" id="endTime" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">Duration (hrs)</label>
        <input type="number" class="form-control" id="duration" readonly />
      </div>
      <div class="col-md-3">
        <label class="form-label">Extra Hours</label>
        <input type="number" class="form-control" id="extraHours" required />
      </div>
    </div>

    <!-- 📏 DISTANCE DETAILS -->
    <h5>📏 Distance Details</h5>
    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label">Start KM</label>
        <input type="number" class="form-control" id="startKm" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">End KM</label>
        <input type="number" class="form-control" id="endKm" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">Total KM</label>
        <input type="number" class="form-control" id="totalKm" readonly />
      </div>
      <div class="col-md-3">
        <label class="form-label">Extra KM</label>
        <input type="number" class="form-control" id="extraKm" required />
      </div>
    </div>

    <!-- 💰 FARE DETAILS -->
    <h5>💰 Fare Details</h5>
    <div class="row mb-4">
      <div class="col-md-3">
        <label class="form-label">Parking (₹)</label>
        <input type="number" class="form-control" id="parking" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">Toll (₹)</label>
        <input type="number" class="form-control" id="toll" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">Total Amount (₹)</label>
        <input type="number" class="form-control" id="totalAmount" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">Payment Status</label>
        <select class="form-select" id="paymentStatus">
          <option value="Paid">Paid</option>
          <option value="Pending">Pending</option>
        </select>
      </div>
    </div>

    <button type="submit" class="btn btn-success w-100">📤 Share on WhatsApp</button>
  </form>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, push, get, child, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCz2rGDr0iREns6Rg6r1z5EHE3qhLDnEzs",
    authDomain: "narayananselvitravels-26dcb.firebaseapp.com",
    databaseURL: "https://narayananselvitravels-26dcb-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "narayananselvitravels-26dcb",
    storageBucket: "narayananselvitravels-26dcb.firebasestorage.app",
    messagingSenderId: "395599682835",
    appId: "1:395599682835:web:9d46e03ca14aa0738dcee6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const dbRef = ref(db);

  function timeToMinutes(t) {
    const [h, m] = t.split(":").map(Number);
    return h * 60 + m;
  }

  async function generateTripId() {
    const counterRef = ref(db, 'tripCounter');
    const snap = await get(counterRef);
    let count = 0;
    if (snap.exists()) {
      count = snap.val();
    }
    count++;
    await set(counterRef, count);
    return `#NST${String(count).padStart(3, '0')}`;
  }

  async function tripIdExists(tripId) {
    const snap = await get(child(dbRef, 'trips'));
    if (snap.exists()) {
      return Object.values(snap.val()).some(trip => trip.bookingId === tripId);
    }
    return false;
  }

  function generateWhatsAppMessage(data) {
    return `
📋 *${data.bookingId} - NST Trip Summary*
🗓 *Date:* ${data.date}
📍 *Pickup:* ${data.pickupLocation}
📍 *Drop:* ${data.dropLocation}
🎯 *Duty:* ${data.duty}
🔖 *Reference:* ${data.reference}

👤 *Customer:* ${data.customerName} (${data.customerNumber})
👨‍✈️ *Driver:* ${data.driverName} (${data.driverNumber})
🚘 *Vehicle:* ${data.vehicleModel} (${data.vehicleNumber})

🕒 *Time:* ${data.startTime} - ${data.endTime} (${data.duration} hrs)
➕ *Extra Hours:* ${data.extraHours}

📏 *KM:* ${data.startKm} - ${data.endKm} = ${data.totalKm} km
➕ *Extra KM:* ${data.extraKm}

💰 *Parking:* ₹${data.parking}
💰 *Toll:* ₹${data.toll}
💵 *Total:* ₹${data.totalAmount}
💳 *Payment:* ${data.paymentStatus}
`.trim();
  }

  async function loadDrivers() {
    const driverSelect = document.getElementById('driverName');
    const snap = await get(child(dbRef, 'drivers'));
    driverSelect.innerHTML = '<option value="">Select Driver</option>';
    if (snap.exists()) {
      const drivers = snap.val();
      for (const key in drivers) {
        const d = drivers[key];
        // Store number as data attribute
        driverSelect.innerHTML += `<option value="${d.name}" data-number="${d.number}">${d.name}</option>`;
      }
    }
  }

  async function loadVehicles() {
    const vehicleSelect = document.getElementById('vehicleModel');
    const snap = await get(child(dbRef, 'vehicles'));
    vehicleSelect.innerHTML = '<option value="">Select Vehicle Model</option>';
    if (snap.exists()) {
      const vehicles = snap.val();
      for (const key in vehicles) {
        const v = vehicles[key];
        // Store number as data attribute
        vehicleSelect.innerHTML += `<option value="${v.model}" data-number="${v.number}">${v.model}</option>`;
      }
    }
  }

  window.addEventListener("DOMContentLoaded", async () => {
    document.getElementById("bookingId").value = await generateTripId();

    await loadDrivers();
    await loadVehicles();

    document.getElementById("startTime").addEventListener("change", calcDuration);
    document.getElementById("endTime").addEventListener("change", calcDuration);
    document.getElementById("startKm").addEventListener("input", calcTotalKm);
    document.getElementById("endKm").addEventListener("input", calcTotalKm);

    // When driver selected, autofill number
    document.getElementById('driverName').addEventListener('change', (e) => {
      const selected = e.target.selectedOptions[0];
      document.getElementById('driverNumber').value = selected ? selected.getAttribute('data-number') || '' : '';
    });

    // When vehicle model selected, autofill number
    document.getElementById('vehicleModel').addEventListener('change', (e) => {
      const selected = e.target.selectedOptions[0];
      document.getElementById('vehicleNumber').value = selected ? selected.getAttribute('data-number') || '' : '';
    });
  });

  function calcDuration() {
    const start = document.getElementById("startTime").value;
    const end = document.getElementById("endTime").value;
    if (start && end) {
      let sm = timeToMinutes(start);
      let em = timeToMinutes(end);
      if (em < sm) em += 24 * 60;
      document.getElementById("duration").value = ((em - sm) / 60).toFixed(2);
    }
  }

  function calcTotalKm() {
    const sk = parseFloat(document.getElementById("startKm").value);
    const ek = parseFloat(document.getElementById("endKm").value);
    if (!isNaN(sk) && !isNaN(ek) && ek >= sk) {
      document.getElementById("totalKm").value = (ek - sk).toFixed(2);
    }
  }

  document.getElementById("tripForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target;

    const data = {
      bookingId: document.getElementById("bookingId").value,
      date: document.getElementById("date").value,
      duty: document.getElementById("duty").value,
      reference: document.getElementById("reference").value,
      pickupLocation: document.getElementById("pickupLocation").value,
      dropLocation: document.getElementById("dropLocation").value,
      customerName: document.getElementById("customerName").value,
      customerNumber: document.getElementById("customerNumber").value,
      driverName: document.getElementById("driverName").value,
      driverNumber: document.getElementById("driverNumber").value,
      vehicleModel: document.getElementById("vehicleModel").value,
      vehicleNumber: document.getElementById("vehicleNumber").value,
      startTime: document.getElementById("startTime").value,
      endTime: document.getElementById("endTime").value,
      duration: document.getElementById("duration").value,
      extraHours: document.getElementById("extraHours").value,
      startKm: document.getElementById("startKm").value,
      endKm: document.getElementById("endKm").value,
      totalKm: document.getElementById("totalKm").value,
      extraKm: document.getElementById("extraKm").value,
      parking: document.getElementById("parking").value,
      toll: document.getElementById("toll").value,
      totalAmount: document.getElementById("totalAmount").value,
      paymentStatus: document.getElementById("paymentStatus").value
    };

    if (await tripIdExists(data.bookingId)) {
      alert("❌ Trip ID already exists. Cannot save.");
      return;
    }

    await push(ref(db, "trips/"), data);

    const message = generateWhatsAppMessage(data);
    const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
  });
</script>
</body>
</html>
