<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NST Trip Entry</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body {
      background-color: #f4f7fc;
      font-family: 'Segoe UI', sans-serif;
    }
    .container {
      max-width: 900px;
      margin-top: 30px;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    h3, h5 {
      margin-top: 25px;
      font-weight: 600;
    }
    .form-label {
      font-weight: 500;
    }
    .admin-link {
      position: absolute;
      top: 20px;
      right: 20px;
    }
    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
<a href="admin-panel.html" class="btn btn-sm btn-dark admin-link">‚öôÔ∏è Admin Panel</a>
<div class="container">
  <h3>üìã NST Trip Summary</h3>
  <form id="tripForm" autocomplete="off">
    <!-- üóì TRIP DETAILS -->
    <h5>üóì Trip Details</h5>
    <div class="row mb-3">
      <div class="col-md-4">
        <label class="form-label" for="bookingId">Trip ID</label>
        <input type="text" class="form-control" id="bookingId" readonly />
      </div>
      <div class="col-md-4">
        <label class="form-label" for="date">Date</label>
        <input type="date" class="form-control" id="date" />
      </div>
      <div class="col-md-4">
        <label class="form-label" for="duty">Duty</label>
        <input type="text" class="form-control" id="duty" />
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-4">
        <label class="form-label" for="reference">Reference</label>
        <input type="text" class="form-control" id="reference" />
      </div>
    </div>
    <!-- üìç LOCATIONS -->
    <h5>üìç Locations</h5>
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label" for="pickupLocation">Pickup</label>
        <input type="text" class="form-control" id="pickupLocation" />
      </div>
      <div class="col-md-6">
        <label class="form-label" for="dropLocation">Drop</label>
        <input type="text" class="form-control" id="dropLocation" />
      </div>
    </div>
    <!-- üë§ CUSTOMER INFO -->
    <h5>üë§ Customer Info</h5>
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label" for="customerName">Name</label>
        <input type="text" class="form-control" id="customerName" />
      </div>
      <div class="col-md-6">
        <label class="form-label" for="customerNumber">Number</label>
        <input type="tel" class="form-control" id="customerNumber" />
      </div>
    </div>
    <!-- üë®‚Äç‚úà DRIVER INFO -->
    <h5>üë®‚Äç‚úà Driver Info</h5>
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label" for="driverName">Name</label>
        <select class="form-select" id="driverName">
          <option value="" selected disabled>Select Driver</option>
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label" for="driverNumber">Number</label>
        <input type="tel" class="form-control" id="driverNumber" readonly />
      </div>
    </div>
    <!-- üöò VEHICLE INFO -->
    <h5>üöò Vehicle Info</h5>
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label" for="vehicleModel">Model</label>
        <select class="form-select" id="vehicleModel">
          <option value="" selected disabled>Select Vehicle</option>
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label" for="vehicleNumber">Number</label>
        <input type="text" class="form-control" id="vehicleNumber" readonly />
      </div>
    </div>
    <!-- üïí TIME DETAILS -->
    <h5>üïí Time Details</h5>
    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label" for="startTime">Start Time</label>
        <input type="time" class="form-control" id="startTime" />
      </div>
      <div class="col-md-3">
        <label class="form-label" for="endTime">End Time</label>
        <input type="time" class="form-control" id="endTime" />
      </div>
      <div class="col-md-3">
        <label class="form-label" for="duration">Duration (hrs)</label>
        <input type="number" class="form-control" id="duration" readonly />
      </div>
      <div class="col-md-3">
        <label class="form-label" for="extraHours">Extra Hours</label>
        <input type="number" class="form-control" id="extraHours" />
      </div>
    </div>
    <!-- üìè DISTANCE DETAILS -->
    <h5>üìè Distance Details</h5>
    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label" for="startKm">Start KM</label>
        <input type="number" class="form-control" id="startKm" />
      </div>
      <div class="col-md-3">
        <label class="form-label" for="endKm">End KM</label>
        <input type="number" class="form-control" id="endKm" />
      </div>
      <div class="col-md-3">
        <label class="form-label" for="totalKm">Total KM</label>
        <input type="number" class="form-control" id="totalKm" readonly />
      </div>
      <div class="col-md-3">
        <label class="form-label" for="extraKm">Extra KM</label>
        <input type="number" class="form-control" id="extraKm" />
      </div>
    </div>
    <!-- üí∞ FARE DETAILS -->
    <h5>üí∞ Fare Details</h5>
    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label" for="parking">Parking (‚Çπ)</label>
        <input type="number" class="form-control" id="parking" />
      </div>
      <div class="col-md-3">
        <label class="form-label" for="toll">Toll (‚Çπ)</label>
        <input type="number" class="form-control" id="toll" />
      </div>
      <div class="col-md-3">
        <label class="form-label" for="totalAmount">Total Amount (‚Çπ)</label>
        <input type="number" class="form-control" id="totalAmount" />
      </div>
      <div class="col-md-3">
        <label class="form-label" for="paymentStatus">Payment Status</label>
        <select class="form-select" id="paymentStatus">
          <option value="" selected disabled>Select</option>
          <option value="Paid">Paid</option>
          <option value="Not Paid">Not Paid</option>
          <option value="Partially Paid">Partially Paid</option>
        </select>
      </div>
    </div>
    <div class="row mb-3" id="paidAmountRow" style="display:none;">
      <div class="col-md-6">
        <label class="form-label" for="paidAmount">Paid Amount (‚Çπ)</label>
        <input type="number" class="form-control" id="paidAmount" />
      </div>
    </div>
    <div class="row mb-3" id="balanceAmountRow" style="display:none;">
      <div class="col-md-6">
        <label class="form-label" for="balanceAmount">Balance Amount (‚Çπ)</label>
        <input type="number" class="form-control" id="balanceAmount" readonly />
      </div>
    </div>
    <button type="submit" class="btn btn-success w-100">üì§ Share on WhatsApp</button>
  </form>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getDatabase, ref, push, set, child,
  get, onValue
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
const firebaseConfig = {
  apiKey: "AIzaSyCz2rGDr0iREns6Rg6r1z5EHE3qhLDnEzs",
  authDomain: "narayananselvitravels-26dcb.firebaseapp.com",
  databaseURL: "https://narayananselvitravels-26dcb-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "narayananselvitravels-26dcb",
  storageBucket: "narayananselvitravels-26dcb.appspot.com",
  messagingSenderId: "395599682835",
  appId: "1:395599682835:web:9d46e03ca14aa0738dcee6"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbRef = ref(db);
function timeToMinutes(t) {
  const [h, m] = t.split(":").map(Number);
  return h * 60 + m;
}
function formatTimeTo12Hour(time) {
  if (!time) return "";
  const [hours, minutes] = time.split(":").map(Number);
  const period = hours >= 12 ? "PM" : "AM";
  const adjustedHours = hours % 12 || 12;
  return `${adjustedHours}:${minutes.toString().padStart(2, '0')} ${period}`;
}
async function generateTripId() {
  try {
    const snap = await get(child(dbRef, 'tripResetFlag'));
    const reset = snap.exists() && (snap.val() === true || snap.val() === "reset");
    if (reset) return "#NST001";
    const tripsSnap = await get(child(dbRef, 'trips'));
    const count = tripsSnap.exists() ? Object.keys(tripsSnap.val()).length + 1 : 1;
    return `#NST${String(count).padStart(3, '0')}`;
  } catch (error) {
    console.error("Error generating trip ID:", error);
    return "#NST001";
  }
}
async function tripIdExists(tripId) {
  try {
    const snap = await get(child(dbRef, 'trips'));
    if (snap.exists()) {
      return Object.values(snap.val()).some(trip => trip.bookingId === tripId);
    }
    return false;
  } catch (error) {
    console.error("Error checking trip ID:", error);
    return false;
  }
}
function generateWhatsAppMessage(data) {
  const sections = [
    {
      heading: "üóì Trip Details",
      fields: [
        { key: "bookingId", label: "Trip ID", required: false },
        { key: "date", label: "Date", required: false },
        { key: "duty", label: "Duty", required: false },
        { key: "reference", label: "Reference", required: false }
      ]
    },
    {
      heading: "üìç Locations",
      fields: [
        { key: "pickupLocation", label: "Pickup", required: false },
        { key: "dropLocation", label: "Drop", required: false }
      ]
    },
    {
      heading: "üë§ Customer Info",
      fields: [
        { key: "customerName", label: "Customer", required: false },
        { key: "customerNumber", label: "Number", required: false }
      ]
    },
    {
      heading: "üë®‚Äç‚úà Driver Info",
      fields: [
        { key: "driverName", label: "Driver", required: false },
        { key: "driverNumber", label: "Number", required: false }
      ]
    },
    {
      heading: "üöò Vehicle Info",
      fields: [
        { key: "vehicleModel", label: "Vehicle", required: false },
        { key: "vehicleNumber", label: "Number", required: false }
      ]
    },
    {
      heading: "üïí Time Details",
      fields: [
        { key: "startTime", label: "Start Time", required: false, format: formatTimeTo12Hour },
        { key: "endTime", label: "End Time", required: false, format: formatTimeTo12Hour },
        { key: "duration", label: "Duration", required: false, format: v => `${v} hrs` },
        { key: "extraHours", label: "Extra Hours", required: false }
      ]
    },
    {
      heading: "üìè Distance Details",
      fields: [
        { key: "startKm", label: "Start KM", required: false },
        { key: "endKm", label: "End KM", required: false },
        { key: "totalKm", label: "Total KM", required: false, format: v => `${v} km` },
        { key: "extraKm", label: "Extra KM", required: false }
      ]
    },
    {
      heading: "üí∞ Fare Details",
      fields: [
        { key: "parking", label: "Parking", required: false, format: v => `‚Çπ${v}` },
        { key: "toll", label: "Toll", required: false, format: v => `‚Çπ${v}` },
        { key: "totalAmount", label: "Total", required: false, format: v => `‚Çπ${v}` },
        { key: "paymentStatus", label: "Payment", required: false },
        { key: "paidAmount", label: "Paid", required: false, format: v => `‚Çπ${v}` },
        { key: "balanceAmount", label: "Balance", required: false, format: v => `‚Çπ${v}` }
      ]
    }
  ];

  let message = `üìã *${data.bookingId} - NST Trip Summary*`;
  
  sections.forEach(section => {
    const filledFields = section.fields
      .filter(field => {
        const value = data[field.key];
        return value && value !== "0" && value !== "";
      })
      .map(field => {
        const value = data[field.key];
        const formattedValue = field.format ? field.format(value) : value;
        return `‚Ä¢ ${field.label}: ${formattedValue}`;
      });

    if (filledFields.length > 0) {
      message += `\n\n${section.heading}\n${filledFields.join('\n')}`;
    }
  });

  return message.trim();
}
async function loadDrivers() {
  try {
    const snap = await get(child(dbRef, 'drivers'));
    const select = document.getElementById("driverName");
    select.innerHTML = '<option value="" selected disabled>Select Driver</option>';
    if (snap.exists()) {
      const data = snap.val();
      Object.values(data).forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.name;
        opt.text = d.name;
        opt.setAttribute("data-number", d.number || "");
        select.appendChild(opt);
      });
    } else {
      console.warn("No drivers found in Firebase.");
      alert("‚ö†Ô∏è No drivers available. Please add drivers in the admin panel.");
    }
  } catch (error) {
    console.error("Error loading drivers:", error);
    alert("‚ö†Ô∏è Failed to load drivers. Please check your connection.");
  }
}
async function loadVehicles() {
  try {
    const snap = await get(child(dbRef, 'vehicles'));
    const select = document.getElementById("vehicleModel");
    select.innerHTML = '<option value="" selected disabled>Select Vehicle</option>';
    if (snap.exists()) {
      const data = snap.val();
      Object.values(data).forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.model;
        opt.text = v.model;
        opt.setAttribute("data-number", v.number || "");
        select.appendChild(opt);
      });
    } else {
      console.warn("No vehicles found in Firebase.");
      alert("‚ö†Ô∏è No vehicles available. Please add vehicles in the admin panel.");
    }
  } catch (error) {
    console.error("Error loading vehicles:", error);
    alert("‚ö†Ô∏è Failed to load vehicles. Please check your connection.");
  }
}
window.addEventListener("DOMContentLoaded", async () => {
  try {
    document.getElementById("bookingId").value = await generateTripId();
    await Promise.all([loadDrivers(), loadVehicles()]);
    document.getElementById("startTime").addEventListener("change", calcDuration);
    document.getElementById("endTime").addEventListener("change", calcDuration);
    document.getElementById("startKm").addEventListener("input", calcTotalKm);
    document.getElementById("endKm").addEventListener("input", calcTotalKm);
    document.getElementById("driverName").addEventListener("change", function () {
      const number = this.selectedOptions[0]?.getAttribute("data-number") || "";
      document.getElementById("driverNumber").value = number;
    });
    document.getElementById("vehicleModel").addEventListener("change", function () {
      const number = this.selectedOptions[0]?.getAttribute("data-number") || "";
      document.getElementById("vehicleNumber").value = number;
    });
    document.getElementById("paymentStatus").addEventListener("change", handlePaymentStatusChange);
    document.getElementById("paidAmount").addEventListener("input", updateBalanceAmount);
    const resetFlagRef = ref(db, 'tripResetFlag/');
    onValue(resetFlagRef, async (snapshot) => {
      const flag = snapshot.val();
      if (flag === true || flag === "reset") {
        document.getElementById("bookingId").value = "#NST001";
      }
    });
    handlePaymentStatusChange();
  } catch (error) {
    console.error("Error initializing form:", error);
    alert("‚ö†Ô∏è Failed to initialize form. Please refresh the page.");
  }
});
function calcDuration() {
  const start = document.getElementById("startTime").value;
  const end = document.getElementById("endTime").value;
  if (start && end) {
    let sm = timeToMinutes(start);
    let em = timeToMinutes(end);
    if (em < sm) em += 24 * 60;
    document.getElementById("duration").value = ((em - sm) / 60).toFixed(2);
  } else {
    document.getElementById("duration").value = "";
  }
}
function calcTotalKm() {
  const sk = parseFloat(document.getElementById("startKm").value);
  const ek = parseFloat(document.getElementById("endKm").value);
  if (!isNaN(sk) && !isNaN(ek) && ek >= sk) {
    document.getElementById("totalKm").value = (ek - sk).toFixed(2);
  } else {
    document.getElementById("totalKm").value = "";
  }
}
function handlePaymentStatusChange() {
  const status = document.getElementById("paymentStatus").value;
  const paidRow = document.getElementById("paidAmountRow");
  const balanceRow = document.getElementById("balanceAmountRow");
  if (status === "Paid" || status === "Partially Paid") {
    paidRow.style.display = "block";
    balanceRow.style.display = status === "Partially Paid" ? "block" : "none";
  } else {
    paidRow.style.display = "none";
    balanceRow.style.display = "none";
    document.getElementById("paidAmount").value = "";
    document.getElementById("balanceAmount").value = "";
  }
}
function updateBalanceAmount() {
  const total = parseFloat(document.getElementById("totalAmount").value);
  const paid = parseFloat(document.getElementById("paidAmount").value);
  if (!isNaN(total) && !isNaN(paid)) {
    const balance = total - paid;
    document.getElementById("balanceAmount").value = balance >= 0 ? balance.toFixed(2) : "";
  } else {
    document.getElementById("balanceAmount").value = "";
  }
}
document.getElementById("tripForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const form = e.target;
  const driverName = document.getElementById("driverName").value;
  const vehicleModel = document.getElementById("vehicleModel").value;
  if (!driverName || !vehicleModel) {
    alert("‚ùå Please select a driver and vehicle.");
    return;
  }
  const data = {
    bookingId: document.getElementById("bookingId").value,
    date: document.getElementById("date").value,
    duty: document.getElementById("duty").value,
    reference: document.getElementById("reference").value,
    pickupLocation: document.getElementById("pickupLocation").value,
    dropLocation: document.getElementById("dropLocation").value,
    customerName: document.getElementById("customerName").value,
    customerNumber: document.getElementById("customerNumber").value,
    driverName: driverName,
    driverNumber: document.getElementById("driverNumber").value,
    vehicleModel: vehicleModel,
    vehicleNumber: document.getElementById("vehicleNumber").value,
    startTime: document.getElementById("startTime").value,
    endTime: document.getElementById("endTime").value,
    duration: document.getElementById("duration").value,
    extraHours: document.getElementById("extraHours").value,
    startKm: document.getElementById("startKm").value,
    endKm: document.getElementById("endKm").value,
    totalKm: document.getElementById("totalKm").value,
    extraKm: document.getElementById("extraKm").value,
    parking: document.getElementById("parking").value,
    toll: document.getElementById("toll").value,
    totalAmount: document.getElementById("totalAmount").value,
    paymentStatus: document.getElementById("paymentStatus").value,
    paidAmount: document.getElementById("paidAmount").value || "0",
    balanceAmount: document.getElementById("balanceAmount").value || "0"
  };
  try {
    if (await tripIdExists(data.bookingId)) {
      alert("‚ùå Trip ID already exists. Cannot save.");
      return;
    }
    await push(ref(db, "trips/"), data);
    const message = generateWhatsAppMessage(data);
    const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
    form.reset();
    document.getElementById("bookingId").value = await generateTripId();
    document.getElementById("driverName").value = "";
    document.getElementById("vehicleModel").value = "";
    document.getElementById("driverNumber").value = "";
    document.getElementById("vehicleNumber").value = "";
    handlePaymentStatusChange();
  } catch (error) {
    console.error("Error saving trip:", error);
    alert("‚ö†Ô∏è Failed to save trip. Please try again.");
  }
});
</script>
</body>
</html>
