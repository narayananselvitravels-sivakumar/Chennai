<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NST Trip Entry</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body {
      background-color: #f4f7fc;
      font-family: 'Segoe UI', sans-serif;
    }
    .container {
      max-width: 900px;
      margin-top: 30px;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    h3, h5 {
      margin-top: 25px;
      font-weight: 600;
    }
    .form-label {
      font-weight: 500;
    }
    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
    }
    /* Admin Panel Button Styling */
    #adminPanelBtn {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 1000;
      font-weight: 600;
      padding: 10px 15px;
    }
  </style>
</head>
<body>

  <!-- Admin Panel Button -->
  <a href="admin-panel.html" id="adminPanelBtn" class="btn btn-primary">
    Admin Panel
  </a>

  <div class="container">
    <h3>üìã NST Trip Summary</h3>
    <form id="tripForm">

      <!-- üóì TRIP DETAILS -->
      <h5>üóì Trip Details</h5>
      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Trip ID</label>
          <input type="text" class="form-control" id="bookingId" readonly />
        </div>
        <div class="col-md-4">
          <label class="form-label">Date</label>
          <input type="date" class="form-control" id="date" required />
        </div>
        <div class="col-md-4">
          <label class="form-label">Duty</label>
          <input type="text" class="form-control" id="duty" required />
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Reference</label>
          <input type="text" class="form-control" id="reference" />
        </div>
      </div>

      <!-- üìç LOCATIONS -->
      <h5>üìç Locations</h5>
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Pickup</label>
          <input type="text" class="form-control" id="pickupLocation" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Drop</label>
          <input type="text" class="form-control" id="dropLocation" required />
        </div>
      </div>

      <!-- üë§ CUSTOMER INFO -->
      <h5>üë§ Customer Info</h5>
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Name</label>
          <input type="text" class="form-control" id="customerName" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Number</label>
          <input type="tel" class="form-control" id="customerNumber" required />
        </div>
      </div>

      <!-- üë®‚Äç‚úà DRIVER INFO -->
      <h5>üë®‚Äç‚úà Driver Info</h5>
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Name</label>
          <input type="text" class="form-control" id="driverName" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Number</label>
          <input type="tel" class="form-control" id="driverNumber" required />
        </div>
      </div>

      <!-- üöò VEHICLE INFO -->
      <h5>üöò Vehicle Info</h5>
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Model</label>
          <input type="text" class="form-control" id="vehicleModel" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Number</label>
          <input type="text" class="form-control" id="vehicleNumber" required />
        </div>
      </div>

      <!-- üïí TIME DETAILS -->
      <h5>üïí Time Details</h5>
      <div class="row mb-3">
        <div class="col-md-3">
          <label class="form-label">Start Time</label>
          <input type="time" class="form-control" id="startTime" required />
        </div>
        <div class="col-md-3">
          <label class="form-label">End Time</label>
          <input type="time" class="form-control" id="endTime" required />
        </div>
        <div class="col-md-3">
          <label class="form-label">Duration (hrs)</label>
          <input type="number" class="form-control" id="duration" readonly />
        </div>
        <div class="col-md-3">
          <label class="form-label">Extra Hours</label>
          <input type="number" class="form-control" id="extraHours" required />
        </div>
      </div>

      <!-- üìè DISTANCE DETAILS -->
      <h5>üìè Distance Details</h5>
      <div class="row mb-3">
        <div class="col-md-3">
          <label class="form-label">Start KM</label>
          <input type="number" class="form-control" id="startKm" required />
        </div>
        <div class="col-md-3">
          <label class="form-label">End KM</label>
          <input type="number" class="form-control" id="endKm" required />
        </div>
        <div class="col-md-3">
          <label class="form-label">Total KM</label>
          <input type="number" class="form-control" id="totalKm" readonly />
        </div>
        <div class="col-md-3">
          <label class="form-label">Extra KM</label>
          <input type="number" class="form-control" id="extraKm" required />
        </div>
      </div>

      <!-- üí∞ FARE DETAILS -->
      <h5>üí∞ Fare Details</h5>
      <div class="row mb-4">
        <div class="col-md-3">
          <label class="form-label">Parking (‚Çπ)</label>
          <input type="number" class="form-control" id="parking" required />
        </div>
        <div class="col-md-3">
          <label class="form-label">Toll (‚Çπ)</label>
          <input type="number" class="form-control" id="toll" required />
        </div>
        <div class="col-md-3">
          <label class="form-label">Total Amount (‚Çπ)</label>
          <input type="number" class="form-control" id="totalAmount" required />
        </div>
        <div class="col-md-3">
          <label class="form-label">Payment Status</label>
          <select class="form-select" id="paymentStatus">
            <option value="Paid">Paid</option>
            <option value="Pending">Pending</option>
          </select>
        </div>
      </div>

      <button type="submit" class="btn btn-success w-100">üì§ Share on WhatsApp</button>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, push, get, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCz2rGDr0iREns6Rg6r1z5EHE3qhLDnEzs",
      authDomain: "narayananselvitravels-26dcb.firebaseapp.com",
      databaseURL: "https://narayananselvitravels-26dcb-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "narayananselvitravels-26dcb",
      storageBucket: "narayananselvitravels-26dcb.firebasestorage.app",
      messagingSenderId: "395599682835",
      appId: "1:395599682835:web:9d46e03ca14aa0738dcee6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db);

    function timeToMinutes(t) {
      const [h, m] = t.split(":").map(Number);
      return h * 60 + m;
    }

    async function generateTripId() {
      const snap = await get(child(dbRef, 'trips'));
      const count = snap.exists() ? Object.keys(snap.val()).length + 1 : 1;
      return `#NST${String(count).padStart(3, '0')}`;
    }

    async function tripIdExists(tripId) {
      const snap = await get(child(dbRef, 'trips'));
      if (snap.exists()) {
        return Object.values(snap.val()).some(trip => trip.bookingId === tripId);
      }
      return false;
    }

    function generateWhatsAppMessage(data) {
      return `
üìã *${data.bookingId} - NST Trip Summary*
üóì *Date:* ${data.date}
üìç *Pickup:* ${data.pickupLocation}
üìç *Drop:* ${data.dropLocation}
üéØ *Duty:* ${data.duty}
üîñ *Reference:* ${data.reference}

üë§ *Customer:* ${data.customerName} (${data.customerNumber})
üë®‚Äç‚úàÔ∏è *Driver:* ${data.driverName} (${data.driverNumber})
üöò *Vehicle:* ${data.vehicleModel} (${data.vehicleNumber})

üïí *Time:* ${data.startTime} - ${data.endTime} (${data.duration} hrs)
‚ûï *Extra Hours:* ${data.extraHours}

üìè *KM:* ${data.startKm} - ${data.endKm} = ${data.totalKm} km
‚ûï *Extra KM:* ${data.extraKm}

üí∞ *Parking:* ‚Çπ${data.parking}
üí∞ *Toll:* ‚Çπ${data.toll}
üíµ *Total:* ‚Çπ${data.totalAmount}
üí≥ *Payment:* ${data.paymentStatus}
`.trim();
    }

    window.addEventListener("DOMContentLoaded", async () => {
      document.getElementById("bookingId").value = await generateTripId();

      document.getElementById("startTime").addEventListener("change", calcDuration);
      document.getElementById("endTime").addEventListener("change", calcDuration);
      document.getElementById("startKm").addEventListener("input", calcTotalKm);
      document.getElementById("endKm").addEventListener("input", calcTotalKm);
    });

    function calcDuration() {
      const start = document.getElementById("startTime").value;
      const end = document.getElementById("endTime").value;
      if (start && end) {
        let sm = timeToMinutes(start);
        let em = timeToMinutes(end);
        if (em < sm) em += 24 * 60;
        document.getElementById("duration").value = ((em - sm) / 60).toFixed(2);
      }
    }

    function calcTotalKm() {
      const sk = parseFloat(document.getElementById("startKm").value);
      const ek = parseFloat(document.getElementById("endKm").value);
      if (!isNaN(sk) && !isNaN(ek) && ek >= sk) {
        document.getElementById("totalKm").value = (ek - sk).toFixed(2);
      }
    }

    document.getElementById("tripForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;

      const data = Object.fromEntries(new FormData(form));
      data.bookingId = document.getElementById("bookingId").value;

      if (await tripIdExists(data.bookingId)) {
        alert("‚ùå Trip ID already exists. Cannot save.");
        return;
      }

      await push(ref(db, "trips/"), data);

      const message = generateWhatsAppMessage(data);
      const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
      window.open(url, '_blank');
    });
  </script>
</body>
</html>
